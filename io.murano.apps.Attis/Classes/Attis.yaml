Namespaces:
  =: io.murano.apps
  std: io.murano
  sys: io.murano.system

Name: Attis

Extends: std:Application

Properties:
  name:
    Contract: $.string().notNull()
  openLDAP:
    Contract: $.class(OpenLDAP).notNull()
  gerrit:
    Contract: $.class(Gerrit).notNull()
  jenkins:
    Contract: $.class(Jenkins).notNull()
  domain:
    Contract: $.string().notNull()

Methods:
  initialize:
    Body:
      - $._environment: $.find(std:Environment).require()

  deploy:
    Body:
      - If: not $.getAttr(deployed, false)
        Then:
          - $ldapUser: "jenkins"
          - $ldapPass: "openstack"
          - $._environment.reporter.report($this, 'Attis add user to OpenLDAP.')
          - $.openLDAP.configureOpenLDAPUser($.domain, $ldapUser, $ldapPass)
          - $._environment.reporter.report($this, 'Attis user added to OpenLDAP.')
          - If: $.openLDAP.instance.assignFloatingIp
            Then:
              - $ldapHost: $.openLDAP.instance.floatingIpAddress
            Else:
              - $ldapHost: $.openLDAP.instance.ipAddresses[0]
          - $._environment.reporter.report($this, 'Attis have Gerrit connect LDAP')
          - $.gerrit.connectLDAP($ldapHost, $.domain)
          - $._environment.reporter.report($this, 'Attis succeeded connecting LDAP to Gerrit')
          - If: $.gerrit.instance.assignFloatingIp
            Then:
              - $gerritHost: $.gerrit.instance.floatingIpAddress
            Else:
              - $gerritHost: $.gerrit.instance.ipAddresses[0]
          - $._environment.reporter.report($this, 'Attis have Jenkins connect LDAP')
          - $.jenkins.connectLDAP($ldapHost, $.domain)
          - $.jenkins.connectGerrit($gerritHost, $.domain)
          - $._environment.reporter.report($this, 'Attis succeeded connecting LDAP to Jenkins')
          - $._environment.reporter.report($this, 'Attis Jenkins GetKey')
          - $sshKey: $.jenkins.getKey()
          - $._environment.reporter.report($this, 'Attis Gerrit PutKey')
          - $.gerrit.putKey($sshKey)
          - $.setAttr(deployed, true)
